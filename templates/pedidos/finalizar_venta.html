{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pedidos/finalizar_venta.css' %}">
{% endblock %}

{% block content %}
<br>
<div class="container mt-5">
    <div class="card-shadow-test">
        <div class="card-body card-body-custom">
            {% if error %}
            <div class="alert alert-danger" role="alert">{{ error }}</div>
            {% endif %}

            <div class="row">
                <div class="col-md-5 mb-4">
                    <form id="finalizar-venta-form" method="post" action="{% url 'finalizar_venta' pedido.id %}">
                        {% csrf_token %}
                        <div class="form-group mt-2">
                            <label for="{{ form.tipo_pago.id_for_label }}" class="label-text">Método de Pago</label>
                            {{ form.tipo_pago }}
                        </div>
                        <div class="form-group mt-2">
                            <label for="{{ form.cedula_cliente.id_for_label }}" class="label-text">Cédula del Cliente</label>
                            {{ form.cedula_cliente }}
                        </div>
                        <div class="form-group mt-2">
                            <label for="{{ form.impuesto.id_for_label }}" class="label-text">Impuesto</label>
                            {{ form.impuesto }}
                        </div>
                </div>
  
                <div class="col-md-7 mb-4 border-left">
                    {% if pedido.itempedido_set.all %}
                    <table class="table table-hover bg-white">
                        <tbody>
                            {% for item in pedido.itempedido_set.all %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input" id="check{{ item.id }}" name="item_check">
                                </td>
                                <td>
                                    <a href="{% url 'detalle_pedido' pedido.mesa.id %}" class="text-dark">
                                        <h5>{{ item.plato.nombre }} ($ {{ item.plato.precio|floatformat:0|intcomma }})</h5>
                                    </a>
                                </td>
                                <td>
                                    <h4>{{ item.cantidad }}</h4>
                                </td>
                                <td>
                                    <span class="badge badge-custom-large text-dark rounded-pill item-total">
                                        $ {{ item.total|floatformat:0|intcomma }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <div class="alert alert-warning" role="alert">No hay artículos en el pedido.</div>
                    {% endif %}

                    <div class="card transparent-card">
                        <h3 class="label-text mx-2">Subtotal de articulos seleccionados: $<span id="totalSeleccionado">0.00</span></h3>
                        <h3 class="label-text mx-2">Subtotal restante: $<span id="totalRestanteCal">{{ total|floatformat:0|intcomma }}</span></h3>
                    </div>
                    <br>
                    <div class="form-group d-flex align-items-center">
                        <div class="discount-controls d-flex align-items-center">
                            <button type="button" class="btn-outline-secondary mx-2" id="btnDisminuirDescuento">-</button>
                            <input type="text" name="descuento" class="descuento-field" id="descuento-field" value="0">
                            <button type="button" class="btn-outline-secondary mx-2" id="btnAumentarDescuento">+</button>
                        </div>
                        <button type="button" class="btn-descuento" id="btnAplicarDescuento">% descuento</button>
                    </div>
                    <br>
                    <div class="form-group d-flex align-items-center">
                        <div class="discount-controls d-flex align-items-center">
                            <button type="button" class="btn-outline-secondary mx-2" id="btnDisminuirPropina">-</button>
                            <input type="text" name="propina" class="propina-field" value="0">
                            <button type="button" class="btn-outline-secondary mx-2" id="btnAumentarPropina">+</button>
                        </div>
                        <button type="button" class="btn-descuento" id="btnGuardarPropina">% propina</button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="badge-container d-flex justify-content-center">
            <span class="badge badge-custom-large bg-hover rounded-pill label-text" id="totalRestante" data-total="{{ total|floatformat:3 }}">
                Subtotal $ <span class="text-value price-text"> {{ total|floatformat:0|intcomma }}</span>
                <img src="{% static 'icons/cash_fgreen.svg' %}" alt="Mesa" style="width:32px; height:32px;">
            </span>
        </div>
        <div class="card-footer text-center">
            <div class="footer-content d-flex flex-column align-items-center">
                <div class="button-group">
                    <a href="{% url 'crear_pedido' %}">
                        <button type="button" class="btn-volver">
                            <img src="{% static 'icons/back_bdark.svg' %}" alt="Mesa" style="width:43px; height:40px;"> Volver
                        </button>
                    </a>
                    <button type="button" class="btn-total" data-bs-toggle="modal" data-bs-target="#ModalFinalizar" {% if disable_buttons %}disabled{% endif %}>
                        <img src="{% static 'icons/cart_check_sgreen.svg' %}" alt="Mesa" style="width:43px; height:40px;"> cobrar Mesa {{ pedido.mesa.numero }}
                    </button>
                </div>
                
            </div>
        </div>
        

    </div>
</div>

<div class="modal fade" id="ModalFinalizar" tabindex="-1" role="dialog" aria-labelledby="finalizarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-custom-position-pago" role="document">
        <div class="modal-content bg-white">
            <div class="modal-header">
                <h5 class="modal-title" id="finalizarModalLabel">Confirmar Venta</h5>
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'imprimir_factura' compra_id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-dark" data-dismiss="modal">ꜰᴀᴄᴛᴜʀᴀ ᴇʟᴇᴄᴛʀᴏɴɪᴄᴀ</button>
                </form>
                <button type="submit" form="finalizar-venta-form" class="btn btn-warning" data-dismiss="modal">ꜰᴀᴄᴛᴜʀᴀ ᴘᴏs</button>
            </div>
        </div>
    </div>
</div>
<br>
<script src="{% static 'js/pedidos/finalizar_venta.js' %}"></script>
<script src="{% static 'js/pedidos/actualizar_totales.js' %}"></script>
{% endblock %}
